<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>47.7 freedomtothesound</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville&display=swap" rel="stylesheet">
    <!-- Mobile-specific meta tags -->
    <meta name="theme-color" content="#FEE5A6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        /* Base styles */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Libre Baskerville', serif;
            background: #FEE5A6;
            color: #333;
            transition: background-color 0.3s ease;
        }
        
        body.dark-mode {
            background: #222;
            color: #eee;
        }
        
        /* Header styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(254, 229, 166, 0.9);
            z-index: 1000;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.dark-mode .header {
            background: rgba(40, 40, 40, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo {
            height: 40px;
            animation: spin 5s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Dark mode toggle style */
        .dark-mode-toggle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #333;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0;
        }
        
        body.dark-mode .dark-mode-toggle {
            background: #fff;
        }
        
        /* Scrolling text in header */
        .scrolling-text {
            flex-grow: 1;
            margin: 0 20px;
            white-space: nowrap;
            overflow: hidden;
            text-align: center;
        }
        
        .scrolling-text-content {
            display: inline-block;
            padding-left: 100%;
            animation: scroll 20s linear infinite;
        }
        
        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        
        /* Main container */
        .main-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 80px 10px 60px;
            box-sizing: border-box;
        }

        /* Radio container */
        .radio-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* Cover art styling */
        .cover-art {
            display: block;
            width: 180px;
            height: 180px;
            margin: 0 auto 15px;
            object-fit: cover;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .cover-art:hover {
            transform: scale(1.05);
        }
        
        /* Custom player styling */
        .custom-player {
            width: 100%;
            background: transparent;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .player-controls {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            width: 100%;
            position: relative;
        }
        
        /* Play button style */
        .play-btn {
            width: 30px;
            height: 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            padding: 0;
            color: #666;
        }
        
        .play-btn:hover {
            transform: scale(1.1);
        }
        
        body.dark-mode .play-btn {
            color: #aaa;
        }
        
        .player-info {
            flex-grow: 1;
            text-align: center;
            overflow: hidden;
            padding: 0 10px;
        }
        
        .song-title {
            font-weight: bold;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .song-artist {
            font-size: 0.9em;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        body.dark-mode .song-artist {
            color: #aaa;
        }
        
        .progress-container {
            width: 100%;
            height: 5px;
            background: rgba(0,0,0,0.1);
            border-radius: 5px;
            margin-top: 10px;
            cursor: pointer;
        }
        
        body.dark-mode .progress-container {
            background: rgba(255,255,255,0.1);
        }
        
        .progress-bar {
            height: 100%;
            background: #FFA500;
            border-radius: 5px;
            width: 0%;
            transition: width 0.1s linear;
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 0.8em;
            margin-top: 5px;
            color: #666;
        }
        
        body.dark-mode .time-display {
            color: #aaa;
        }
        
        /* Volume controls - Mobile improvements */
        .volume-control {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .volume-btn {
            width: 30px;
            height: 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            padding: 0;
            color: #666;
        }
        
        .volume-btn:hover {
            transform: scale(1.1);
        }
        
        .volume-icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        
        body.dark-mode .volume-btn {
            color: #aaa;
        }
        
        .volume-slider-container {
            position: absolute;
            left: 50%;
            bottom: 100%;
            transform: translateX(-50%);
            width: 20px;
            height: 120px;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 15px 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 10;
            display: flex;
            justify-content: center;
        }
        
        body.dark-mode .volume-slider-container {
            background: rgba(40,40,40,0.9);
        }
        
        .volume-control:hover .volume-slider-container,
        .volume-slider-container.visible {
            opacity: 1;
            pointer-events: all;
        }
        
        .volume-slider {
            -webkit-appearance: slider-vertical;
            width: 100px;
            height: 20px;
            transform: rotate(270deg);
            position: absolute;
            top: 50px;
            touch-action: none;
        }
        
        /* History section */
        .history-container {
            width: 100%;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        body.dark-mode .history-container {
            background: rgba(255,255,255,0.05);
        }
        
        .history-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #444;
        }
        
        body.dark-mode .history-title {
            color: #aaa;
        }
        
        .history-list {
            max-height: 350px;
            overflow-y: auto;
        }
        
        .history-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        body.dark-mode .history-item {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item-art {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-right: 10px;
            object-fit: cover;
        }
        
        .history-item-info {
            flex-grow: 1;
            overflow: hidden;
        }
        
        .history-item-title {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .history-item-artist {
            font-size: 0.8em;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        body.dark-mode .history-item-artist {
            color: #aaa;
        }
        
        .history-item-time {
            font-size: 0.8em;
            color: #888;
            margin-left: 10px;
            white-space: nowrap;
        }
        
        /* Footer styles */
        .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(254, 229, 166, 0.9);
            z-index: 1000;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.dark-mode .footer {
            background: rgba(40, 40, 40, 0.9);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .footer-left, .footer-right {
            color: #333;
            text-decoration: none;
            font-size: 1em;
        }
        
        body.dark-mode .footer-left, 
        body.dark-mode .footer-right {
            color: #eee;
        }
        
        .footer a {
            color: inherit;
            text-decoration: none;
        }
        
        /* Scrolling text in footer */
        .footer-scrolling-text {
            flex-grow: 1;
            margin: 0 20px;
            white-space: nowrap;
            overflow: hidden;
            text-align: center;
        }
        
        .footer-scrolling-text-content {
            display: inline-block;
            padding-left: 100%;
            animation: scroll 15s linear infinite;
        }
        
        /* Mobile adjustments */
        @media (max-width: 480px) {
            .cover-art {
                width: 150px;
                height: 150px;
            }
            
            .player-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .play-btn {
                margin-bottom: 10px;
            }
            
            .volume-slider-container {
                left: auto;
                right: 0;
                transform: none;
            }
            
            .history-container {
                max-height: 300px;
            }
            
            .history-list {
                max-height: 250px;
            }
            
            .header, .footer {
                padding: 10px 15px;
            }
            
            .scrolling-text, .footer-scrolling-text {
                margin: 0 10px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <!-- Header with logo and scrolling song info -->
    <div class="header">
        <a href="index.html">
            <img src="logo.png" alt="Logo" class="logo">
        </a>
        <div class="scrolling-text">
            <div class="scrolling-text-content" id="header-song-info">Loading song information...</div>
        </div>
        <button id="dark-mode-toggle" class="dark-mode-toggle"></button>
    </div>

    <!-- Main Content -->
    <div class="main-container">
        <div class="radio-container">
            <!-- Cover Art -->
            <img id="cover-art" class="cover-art" src="https://via.placeholder.com/200" alt="Now Playing">
            
            <!-- Custom Player -->
            <div class="custom-player">
                <div class="player-controls">
                    <button id="play-btn" class="play-btn">
                        <svg class="volume-icon" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </button>
                    <div class="player-info">
                        <div id="song-title" class="song-title">47.7 freedomtothesound</div>
                        <div id="song-artist" class="song-artist">Click play to start listening</div>
                    </div>
                    <div class="volume-control">
                        <button id="volume-btn" class="volume-btn">
                            <svg class="volume-icon" viewBox="0 0 24 24">
                                <path class="volume-icon-base" d="M3 15V9H7L12 4V20L7 15H3Z"/>
                                <path class="volume-icon-low" d="M16.5 12C16.5 10.23 15.48 8.71 14 7.97V16.02C15.48 15.29 16.5 13.77 16.5 12Z"/>
                                <path class="volume-icon-high" d="M14 3.23V5.29C16.89 6.15 19 8.83 19 12C19 15.17 16.89 17.85 14 18.71V20.77C18.01 19.86 21 16.28 21 12C21 7.72 18.01 4.14 14 3.23Z"/>
                            </svg>
                        </button>
                        <div class="volume-slider-container" id="volume-slider-container">
                            <input type="range" id="volume-slider" class="volume-slider" min="0" max="1" step="0.01" value="0.8">
                        </div>
                    </div>
                </div>
                <div class="progress-container" id="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="time-display">
                    <span id="current-time">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>
            
            <!-- Custom History Section -->
            <div class="history-container">
                <div class="history-title">Recently Played</div>
                <div class="history-list" id="history-list">
                    <div class="history-item loading">
                        <img class="history-item-art" src="https://via.placeholder.com/40" alt="Loading">
                        <div class="history-item-info">
                            <div class="history-item-title">Loading history...</div>
                            <div class="history-item-artist">Please wait</div>
                        </div>
                        <div class="history-item-time">--:--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer with scrolling text -->
    <div class="footer">
        <div class="footer-left"><a href="https://www.instagram.com/freedomtothesound/" target="_blank">℗©freedomtothesound</a></div>
        <div class="footer-scrolling-text">
            <div class="footer-scrolling-text-content">47.7 freedomtothesound 24/7 live radio</div>
        </div>
        <div class="footer-right"><a href="contact.html">Contact</a></div>
    </div>

    <script>
        // Player elements
        const playBtn = document.getElementById('play-btn');
        const progressBar = document.getElementById('progress-bar');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        const songTitleEl = document.getElementById('song-title');
        const songArtistEl = document.getElementById('song-artist');
        const volumeBtn = document.getElementById('volume-btn');
        const volumeSlider = document.getElementById('volume-slider');
        const volumeSliderContainer = document.getElementById('volume-slider-container');
        const historyList = document.getElementById('history-list');
        const coverArt = document.getElementById('cover-art');
        const headerSongInfo = document.getElementById('header-song-info');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const body = document.body;
        
        // Audio player - Initialize with stream URL
        const audio = new Audio('https://radio.wearfoi.com/radio/8000/radio.mp3');
        audio.crossOrigin = "anonymous"; // Important for MediaSession API
        
        let isPlaying = false;
        let currentSongId = null;
        let updateInterval;
        let songStartTime = 0;
        let songDuration = 0;
        let lastUpdateTime = 0;
        let volumeVisible = false;
        let retryCount = 0;
        const maxRetries = 5;
        const maxHistoryItems = 20;
        let previousVolume = 0.8;
        let isMuted = false;
        let isVolumeDragging = false;

        // Initialize dark mode
        function initDarkMode() {
            const isDark = localStorage.getItem('dark-mode') === 'enabled';
            body.classList.toggle('dark-mode', isDark);
            darkModeToggle.style.background = isDark ? '#fff' : '#333';
        }

        // Format time (seconds to MM:SS)
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }

        // Format date/time for history
        function formatHistoryTime(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Update progress bar based on song position
        function updateProgress() {
            const now = Date.now();
            if (songDuration > 0 && now - lastUpdateTime > 200) {
                const elapsed = (now - songStartTime) / 1000;
                const progressPercent = Math.min(100, (elapsed / songDuration) * 100);
                progressBar.style.width = `${progressPercent}%`;
                currentTimeEl.textContent = formatTime(elapsed);
                durationEl.textContent = formatTime(songDuration);
                lastUpdateTime = now;
            }
        }

        // Play/pause toggle - FIXED: Working implementation
        function togglePlay() {
            if (isPlaying) {
                audio.pause();
                playBtn.innerHTML = '<svg class="volume-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
                clearInterval(updateInterval);
                updateMediaPlaybackState();
            } else {
                // Handle mobile browser autoplay restrictions
                const playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        // Audio playback started successfully
                        isPlaying = true;
                        playBtn.innerHTML = '<svg class="volume-icon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
                        updateInterval = setInterval(updateProgress, 200);
                        updateMediaPlaybackState();
                    })
                    .catch(error => {
                        console.log('Playback failed:', error);
                        // Show play button since playback failed
                        isPlaying = false;
                        playBtn.innerHTML = '<svg class="volume-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
                        
                        // Try refreshing the audio source
                        if (retryCount < maxRetries) {
                            retryCount++;
                            setTimeout(refreshAudio, 1000);
                        }
                    });
                }
            }
        }

        // Refresh audio source to prevent caching issues
        function refreshAudio() {
            audio.src = 'https://radio.wearfoi.com/radio/8000/radio.mp3?' + Date.now();
            const playPromise = audio.play();
            
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    isPlaying = true;
                    playBtn.innerHTML = '<svg class="volume-icon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
                    retryCount = 0;
                    updateMediaPlaybackState();
                }).catch(e => {
                    console.log('Retry failed:', e);
                    if (retryCount < maxRetries) {
                        retryCount++;
                        setTimeout(refreshAudio, 2000);
                    } else {
                        songTitleEl.textContent = 'Connection Error';
                        songArtistEl.textContent = 'Please refresh page';
                        headerSongInfo.textContent = 'Connection Error - Please refresh page';
                        isPlaying = false;
                        playBtn.innerHTML = '<svg class="volume-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
                        updateMediaPlaybackState();
                    }
                });
            }
        }

        // Update volume
        function updateVolume() {
            if (!isMuted) {
                audio.volume = volumeSlider.value;
            }
            
            // Update volume icon based on level
            const iconLow = document.querySelector('.volume-icon-low');
            const iconHigh = document.querySelector('.volume-icon-high');
            
            if (audio.volume === 0 || isMuted) {
                iconLow.style.display = 'none';
                iconHigh.style.display = 'none';
            } else if (audio.volume < 0.5) {
                iconLow.style.display = '';
                iconHigh.style.display = 'none';
            } else {
                iconLow.style.display = '';
                iconHigh.style.display = '';
            }
        }

        // Toggle mute state
        function toggleMute() {
            isMuted = !isMuted;
            
            if (isMuted) {
                previousVolume = audio.volume > 0 ? audio.volume : 0.8;
                audio.volume = 0;
                volumeSlider.value = 0;
            } else {
                audio.volume = previousVolume;
                volumeSlider.value = previousVolume;
            }
            
            updateVolume();
        }

        // Toggle volume slider visibility
        function toggleVolumeSlider() {
            volumeVisible = !volumeVisible;
            if (volumeVisible) {
                volumeSliderContainer.classList.add('visible');
            } else {
                volumeSliderContainer.classList.remove('visible');
            }
        }

        // Create history item element
        function createHistoryItem(song) {
            const item = document.createElement('div');
            item.className = 'history-item';
            
            const art = document.createElement('img');
            art.className = 'history-item-art';
            art.src = song.art || 'https://via.placeholder.com/40';
            art.alt = 'Album Art';
            art.onerror = () => { 
                art.src = 'https://via.placeholder.com/40';
                art.style.display = 'block';
            };
            
            const info = document.createElement('div');
            info.className = 'history-item-info';
            
            const title = document.createElement('div');
            title.className = 'history-item-title';
            title.textContent = song.title || 'Unknown Track';
            
            const artist = document.createElement('div');
            artist.className = 'history-item-artist';
            artist.textContent = song.artist || 'Unknown Artist';
            
            const time = document.createElement('div');
            time.className = 'history-item-time';
            time.textContent = formatHistoryTime(song.played_at);
            
            info.appendChild(title);
            info.appendChild(artist);
            
            item.appendChild(art);
            item.appendChild(info);
            item.appendChild(time);
            
            return item;
        }

        // Update history list (newest at top, max 20 items)
        function updateHistory() {
            historyList.innerHTML = '';
            
            if (historyData.length === 0) {
                const loadingItem = document.createElement('div');
                loadingItem.className = 'history-item loading';
                loadingItem.innerHTML = `
                    <img class="history-item-art" src="https://via.placeholder.com/40" alt="Loading">
                    <div class="history-item-info">
                        <div class="history-item-title">No history available</div>
                        <div class="history-item-artist">Check back later</div>
                    </div>
                    <div class="history-item-time">--:--</div>
                `;
                historyList.appendChild(loadingItem);
                return;
            }
            
            // Add items in chronological order (newest at top)
            const itemsToShow = historyData.slice(0, maxHistoryItems);
            itemsToShow.forEach(song => {
                historyList.appendChild(createHistoryItem(song));
            });
        }

        // Media Session API functions
        function setupMediaSession() {
            if ('mediaSession' in navigator) {
                // Set up media session actions
                navigator.mediaSession.setActionHandler('play', () => {
                    if (!isPlaying) togglePlay();
                });
                
                navigator.mediaSession.setActionHandler('pause', () => {
                    if (isPlaying) togglePlay();
                });
                
                // Prevent default behavior for these actions
                try {
                    navigator.mediaSession.setActionHandler('seekbackward', null);
                    navigator.mediaSession.setActionHandler('seekforward', null);
                    navigator.mediaSession.setActionHandler('seekto', null);
                } catch (error) {
                    console.log('Media Session actions not supported:', error);
                }
            }
        }
        
        function updateMediaMetadata() {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: songTitleEl.textContent,
                    artist: songArtistEl.textContent,
                    artwork: [
                        { src: coverArt.src || 'https://via.placeholder.com/200', sizes: '180x180', type: 'image/jpeg' }
                    ]
                });
            }
        }
        
        function updateMediaPlaybackState() {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = isPlaying ? 'playing' : 'paused';
            }
        }

        // Setup volume controls for mobile
        function setupVolumeControls() {
            // Click/touch handler for volume button
            volumeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleMute();
            });
            
            // Touch events for volume slider
            volumeSlider.addEventListener('touchstart', (e) => {
                e.stopPropagation();
                isVolumeDragging = true;
                volumeSliderContainer.classList.add('visible');
                volumeVisible = true;
            });
            
            volumeSlider.addEventListener('touchend', () => {
                isVolumeDragging = false;
                setTimeout(() => {
                    if (!volumeVisible) return;
                    volumeSliderContainer.classList.remove('visible');
                    volumeVisible = false;
                }, 2000);
            });
            
            // Prevent page scroll when adjusting volume
            document.addEventListener('touchmove', (e) => {
                if (isVolumeDragging) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // Hide volume slider when tapping elsewhere
            document.addEventListener('touchstart', (e) => {
                if (!volumeSliderContainer.contains(e.target) && e.target !== volumeBtn) {
                    volumeSliderContainer.classList.remove('visible');
                    volumeVisible = false;
                }
            });
        }

        // Fetch now playing data
        function fetchNowPlaying() {
            fetch('https://radio.wearfoi.com/api/nowplaying/47.7_freedomtothesound?' + Date.now())
                .then(response => response.json())
                .then(data => {
                    retryCount = 0; // Reset retry count on successful fetch
                    
                    if (data.now_playing) {
                        const nowPlaying = data.now_playing;
                        const song = nowPlaying.song || {};
                        const elapsed = nowPlaying.elapsed || 0;
                        const duration = nowPlaying.duration || 0;
                        
                        // Only update if song changed
                        if (song.id !== currentSongId) {
                            currentSongId = song.id;
                            songDuration = duration;
                            songStartTime = Date.now() - (elapsed * 1000);
                            
                            // Update cover art
                            if (song.art) {
                                coverArt.src = song.art;
                                coverArt.style.display = 'block';
                                coverArt.onerror = () => { 
                                    coverArt.src = 'https://via.placeholder.com/200';
                                    coverArt.style.display = 'block';
                                };
                            } else {
                                coverArt.src = 'https://via.placeholder.com/200';
                                coverArt.style.display = 'block';
                            }
                            
                            // Update song info
                            const title = song.title || 'Unknown Track';
                            const artist = song.artist || 'Unknown Artist';
                            
                            songTitleEl.textContent = title;
                            songArtistEl.textContent = artist;
                            headerSongInfo.textContent = `${title} by ${artist}`;
                            
                            // Update page title
                            document.title = `${artist} - ${title} | 47.7 freedomtothesound`;
                            
                            // Update media session metadata
                            updateMediaMetadata();
                            
                            // Start progress updates if playing
                            if (isPlaying && !updateInterval) {
                                updateInterval = setInterval(updateProgress, 200);
                            }
                        }
                    }

                    // Update history if available
                    if (data.song_history) {
                        historyData = data.song_history.map(item => {
                            return {
                                title: item.song ? item.song.title : 'Unknown Track',
                                artist: item.song ? item.song.artist : 'Unknown Artist',
                                art: item.song ? item.song.art : 'https://via.placeholder.com/40',
                                played_at: item.played_at || Math.floor(Date.now() / 1000)
                            };
                        });
                        updateHistory();
                    }
                })
                .catch(error => {
                    console.log('Error fetching data:', error);
                    songTitleEl.textContent = 'Updating...';
                    songArtistEl.textContent = 'Connection in progress';
                    headerSongInfo.textContent = 'Updating... Connection in progress';
                    
                    if (retryCount < maxRetries) {
                        retryCount++;
                        setTimeout(fetchNowPlaying, 3000);
                    } else {
                        songTitleEl.textContent = 'Connection Error';
                        songArtistEl.textContent = 'Please refresh page';
                        headerSongInfo.textContent = 'Connection Error - Please refresh page';
                    }
                });
        }

        // Toggle dark mode
        darkModeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');
            darkModeToggle.style.background = isDark ? '#fff' : '#333';
            localStorage.setItem('dark-mode', isDark ? 'enabled' : 'disabled');
        });

        // Initialize everything
        function init() {
            initDarkMode();
            setupVolumeControls();
            setupMediaSession();
            
            // Set up play button event listener
            playBtn.addEventListener('click', togglePlay);
            
            // Set up volume slider
            volumeSlider.addEventListener('input', updateVolume);
            audio.addEventListener('volumechange', updateVolume);
            
            // Initialize volume
            audio.volume = 0.8;
            volumeSlider.value = 0.8;
            updateVolume();
            
            // Start with player paused
            isPlaying = false;
            playBtn.innerHTML = '<svg class="volume-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
            
            // Start fetching now playing data
            fetchNowPlaying();
            
            // Handle mobile browser tab switching
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible' && isPlaying) {
                    // Small delay to ensure audio context is resumed
                    setTimeout(() => {
                        audio.play().catch(e => console.log('Playback resume error:', e));
                    }, 300);
                }
            });
            
            // Schedule regular now playing updates
            setInterval(fetchNowPlaying, 3000);
        }

        // Start the app
        init();
    </script>
</body>
</html>